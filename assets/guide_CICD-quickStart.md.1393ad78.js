import{_ as s,o as n,c as a,a as l}from"./app.9b639de6.js";const p=JSON.parse('{"title":"","description":"","frontmatter":{"footer":false,"outline":"deep"},"headers":[{"level":2,"title":"目标","slug":"目标","link":"#目标","children":[]},{"level":2,"title":"工具及其关系概览","slug":"工具及其关系概览","link":"#工具及其关系概览","children":[]},{"level":2,"title":"准备","slug":"准备","link":"#准备","children":[]},{"level":2,"title":"实施步骤","slug":"实施步骤","link":"#实施步骤","children":[{"level":3,"title":"维护密钥","slug":"维护密钥","link":"#维护密钥","children":[]},{"level":3,"title":"安装argoCD","slug":"安装argocd","link":"#安装argocd","children":[]},{"level":3,"title":"安装argoCD app","slug":"安装argocd-app","link":"#安装argocd-app","children":[]},{"level":3,"title":"向argoCD注册虚拟集群","slug":"向argocd注册虚拟集群","link":"#向argocd注册虚拟集群","children":[]},{"level":3,"title":"向vault同步宿主集群和运行时集群的认证信息","slug":"向vault同步宿主集群和运行时集群的认证信息","link":"#向vault同步宿主集群和运行时集群的认证信息","children":[]},{"level":3,"title":"执行流水线","slug":"执行流水线","link":"#执行流水线","children":[]}]},{"level":2,"title":"附件","slug":"附件","link":"#附件","children":[{"level":3,"title":"参考链接","slug":"参考链接","link":"#参考链接","children":[]},{"level":3,"title":"安装在宿主集群的argoCD访问地址","slug":"安装在宿主集群的argocd访问地址","link":"#安装在宿主集群的argocd访问地址","children":[]},{"level":3,"title":"安装在vcluster集群的argoCD访问地址","slug":"安装在vcluster集群的argocd访问地址","link":"#安装在vcluster集群的argocd访问地址","children":[]},{"level":3,"title":"tekton-dashboard访问地址","slug":"tekton-dashboard访问地址","link":"#tekton-dashboard访问地址","children":[]},{"level":3,"title":"预置的证书和私钥","slug":"预置的证书和私钥","link":"#预置的证书和私钥","children":[]},{"level":3,"title":"替换服务地址配置","slug":"替换服务地址配置","link":"#替换服务地址配置","children":[]}]}],"relativePath":"guide/CICD-quickStart.md"}'),e={name:"guide/CICD-quickStart.md"},o=[l('<h2 id="目标" tabindex="-1">目标 <a class="header-anchor" href="#目标" aria-hidden="true">#</a></h2><p>基于开源工具搭建CI环境，并实现一个代码提交即构建的流水线。</p><h2 id="工具及其关系概览" tabindex="-1">工具及其关系概览 <a class="header-anchor" href="#工具及其关系概览" aria-hidden="true">#</a></h2><p><img src="/docs/assets/CI-1.01e692c2.jpg" alt="directive syntax graph"></p><ul><li>metallb: k8s的lb工具。</li><li>traefik: 反向代理工具，用于ingress的实现。</li><li>cert-manager: 证书签发工具。</li><li>vault: 密钥管理工具。</li><li>external-secrets: 可以将外部的密钥同步为k8s的secret。</li><li>vcluster: 可以在物理k8s集群中创建虚拟集群的工具。</li><li>argo-events: 提供事件监听、转换和触发的工具。</li><li>tekton: k8s原生的流水线工具。</li></ul><p>【补充工具间关系、说明整体实施结构和协同关系】</p><h2 id="准备" tabindex="-1">准备 <a class="header-anchor" href="#准备" aria-hidden="true">#</a></h2><p>以下服务有多种安装方式，下文只是其中一种方式。</p><p><strong>安装一个kubernetes集群</strong><br> 通过命令安装K3s。</p><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 替换tls-san IP为宿主机IP</span></span>\n<span class="line"><span style="color:#A6ACCD;">curl -sfL https://get.k3s.io </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> INSTALL_K3S_VERSION=v1.21.14+k3s1 sh -s - server --disable servicelb --disable traefik --disable metrics-server --tls-san 119.8.99.179</span></span>\n<span class="line"><span style="color:#A6ACCD;">cp /etc/rancher/k3s/k3s.yaml </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/k3s-config</span></span>\n<span class="line"><span style="color:#A6ACCD;">cp /etc/rancher/k3s/k3s.yaml </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"></span></code></pre></div><p><strong>安装一个vault实例</strong><br> vault有多种安装方式，包括安装包、helm、源码和docker安装。下文使用安装包安装。</p><ul><li><p>下载并配置vault，参见<a href="https://developer.hashicorp.com/vault/docs/install#installing-vault" target="_blank" rel="noreferrer">官网链接</a>。</p></li><li><p>更新默认配置文件，启动vault服务。</p><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># config.hcl的默认路径：/opt/vault/config</span></span>\n<span class="line"><span style="color:#A6ACCD;">cat config.hcl</span></span>\n<span class="line"><span style="color:#A6ACCD;">storage </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">raft</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">     </span></span>\n<span class="line"><span style="color:#A6ACCD;">   path    = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/opt/vault/data</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">   node_id = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node1</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#676E95;">#  更新address端为预置端口</span></span>\n<span class="line"><span style="color:#A6ACCD;">listener </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tcp</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">     </span></span>\n<span class="line"><span style="color:#A6ACCD;">   address     = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">0.0.0.0:31820</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">   tls_disable = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;">disable_mlock = </span><span style="color:#82AAFF;">true</span></span>\n<span class="line"><span style="color:#676E95;">#  更新api_addr和cluster_addr的端口为预置端口</span></span>\n<span class="line"><span style="color:#A6ACCD;">api_addr = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://0.0.0.0:31820</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">   </span></span>\n<span class="line"><span style="color:#A6ACCD;">cluster_addr = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://192.168.0.243:31821</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">ui = </span><span style="color:#82AAFF;">true</span></span>\n<span class="line"></span></code></pre></div></li></ul><p><strong>在宿主机安装argocd命令行</strong><br> 下载并配置argoCD命令行，参见<a href="https://argo-cd.readthedocs.io/en/stable/cli_installation/#download-with-curl" target="_blank" rel="noreferrer">官网链接</a>。</p><p><strong>了解Github DEMO代码库的作用</strong> 【修改措辞】</p><ul><li>配置CI基础环境和代码提交即触发流水线：<a href="https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton" target="_blank" rel="noreferrer">demo-pipeline-argoevents-tekton</a></li><li>存储应用源码和流水线：<a href="https://github.com/lanbingcloud/demo-user-project" target="_blank" rel="noreferrer">demo-user-project</a></li><li>存储应用部署的资源文件：<a href="https://github.com/lanbingcloud/demo-user-deployments" target="_blank" rel="noreferrer">demo-user-deployments</a></li></ul><h2 id="实施步骤" tabindex="-1">实施步骤 <a class="header-anchor" href="#实施步骤" aria-hidden="true">#</a></h2><ul><li><strong>维护密钥</strong>：在vault服务端维护本次DEMO需要的所有密钥，以及密钥的访问策略。</li><li><strong>安装argoCD</strong>：在宿主集群安装argoCD。</li><li><strong>安装argoCD app</strong>： 在宿主集群上的argoCD，创建根project和根app，使得argoCD通过<a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/#app-of-apps-pattern" target="_blank" rel="noreferrer">app of apps</a>的方式自动安装宿主集群的资源、运行时集群以及运行时集群的资源。</li><li><strong>向vault同步宿主集群和运行时集群的认证信息</strong>: 同步集群的认证信息，用于kubernetes资源使用存储在vault的密钥。</li><li><strong>执行流水线</strong>：向fork <a href="https://github.com/lanbingcloud/demo-user-project" target="_blank" rel="noreferrer">demo-user-project</a>的目标代码库推送代码，触发流水线自动执行。</li></ul><h3 id="维护密钥" tabindex="-1">维护密钥 <a class="header-anchor" href="#维护密钥" aria-hidden="true">#</a></h3><p><strong>cert-manager</strong><br> 用于cert-manager给ingress资源颁发证书和私钥。</p><ol><li><p>这里使用<a href="#%E9%A2%84%E7%BD%AE%E7%9A%84%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5">预置的证书和私钥</a>。</p></li><li><p>新增secret：访问vault界面，点击“Secrets”一级菜单，启用Secrets Engines，选择类别为KV，点击Next；进入Enable KV Secrets Engine的配置界面，填写Path为pki，点击Enable Engine；进入当前Secrets Engine的secrets配置界面，点击Create secret，参见下表填写属性值，点击Save完成新增secret。</p></li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Path for this secret</td><td>root</td></tr><tr><td>Secret data - key</td><td>tls.crt</td></tr><tr><td>Secret data - value</td><td><a href="#%E9%A2%84%E7%BD%AE%E7%9A%84%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5">预置的证书</a></td></tr><tr><td>Secret data - key</td><td>tls.key</td></tr><tr><td>Secret data - value</td><td><a href="#%E9%A2%84%E7%BD%AE%E7%9A%84%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5">预置的私钥</a></td></tr></tbody></table><ol start="3"><li>新增Policy：访问vault界面，点击“Policies”一级菜单，点击Create ACL policy，填写Name为pki-root，参见下文代码块填写policy，点击Create policy完成新增Policy。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;pki/data/root&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">  capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><strong>argo-events</strong><br> 用于argoevents创建webhook。包括：创建github webhook的accesstoken、防止webhook被非法调用的github secret。</p><ol><li>新增github accesstoken：访问github界面，在“账号Settings - Developer settings - Personal access token - Token(classic)”操作路径下，点击Generate new token(classic)，参见下表填写属性值，点击Generate token完成新增accesstoken。保存生成的token，关闭界面之后将不再显示。更多细节<a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="noreferrer">参见官网</a>。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Note</td><td>自定义描述</td></tr><tr><td>Expiration</td><td>30days(默认值)</td></tr><tr><td>Select scopes(复选框)</td><td>repo、write:packages</td></tr></tbody></table><ol start="2"><li>新增github secret：访问目标代码库（fork <a href="https://github.com/lanbingcloud/demo-user-project" target="_blank" rel="noreferrer">demo-user-project</a>）的github界面，在“Settings-Secrets-Actions”操作路径下，点击New repository secret，参见下表填写属性，点击Add secret完成新增secret。保存明文的secrets，关闭界面之后将不再显示明文。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Name</td><td>自定义名称</td></tr><tr><td>Secret</td><td>随机字符串(例如UUID)</td></tr></tbody></table><ol start="3"><li>新增secret：访问vault界面，点击“Secrets”一级菜单，启用Secrets Engines，选择类别为KV，点击Next；进入Enable KV Secrets Engine的配置界面，填写Path为git，点击Enable Engine；进入当前Secrets Engine的secrets配置界面，点击Create secret，参见下表填写属性值，点击Save完成新增secret。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Path for this secret</td><td>github/user-project/argoevents/webhook-access</td></tr><tr><td>Secret data - key</td><td>token</td></tr><tr><td>Secret data - value</td><td>github accesstoken的值</td></tr><tr><td>Secret data - key</td><td>secret</td></tr><tr><td>Secret data - value</td><td>github secret的值（明文）</td></tr></tbody></table><ol start="4"><li>新增Policy：访问vault界面，点击“Policies”一级菜单，点击Create ACL policy，填写Name为git-github-user-project-argoevents-webhook-access，参见下文代码块填写policy，点击Create policy完成新增Policy。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;git/data/github/user-project/argoevents/webhook-access&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">  capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><strong>pipeline-推送镜像</strong><br> 用于向github package推送镜像。</p><ol><li>准备推送镜像的账号信息：这里使用了和argo-events相同的accesstoken，具备packages的写入权限，组成 &lt;github account&gt;:&lt;github access token&gt; 格式的字符。再通过base64转码，用于后续写入密钥。</li></ol><ol start="2"><li>新增secret：访问vault界面，点击“Secrets”一级菜单，启用Secrets Engines，选择类别为KV，点击Next；进入Enable KV Secrets Engine的配置界面，填写Path为repo，点击Enable Engine；进入当前Secrets Engine的secrets配置界面，点击Create secret，参见下表填写属性值，点击Save完成新增secret。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Path for this secret</td><td>github/container/lanbing/default/readwrite</td></tr><tr><td>Secret data - key</td><td>auth</td></tr><tr><td>Secret data - value</td><td>对github access token进行base64转码后的值</td></tr></tbody></table><ol start="3"><li>新增Policy：访问vault界面，点击“Policies”一级菜单，点击Create ACL policy，填写Name为repo-github-container-lanbing-default-readwrite，参见下文代码块填写policy，点击Create policy完成新增Policy。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;repo/data/github/container/lanbing/default/readwrite&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">    capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><strong>pipeline-推送代码</strong><br> 用于向github代码库推送代码。</p><ol><li>新增ssh密钥：更多细节参见<a href="https://docs.github.com/zh/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent" target="_blank" rel="noreferrer">官网</a>。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 使用git客户端生成密钥，其中邮箱替换为github账号的邮箱 </span></span>\n<span class="line"><span style="color:#A6ACCD;">ssh-keygen -t ed25519 -C </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">your_email@example.com</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>新增deploy key：在目标代码库(fork <a href="https://github.com/lanbingcloud/demo-user-deployments" target="_blank" rel="noreferrer">demo-user-deployments</a>)的github界面，点击顶部的Settings，进入设置界面；点击左侧菜单的Deploy keys，进入Deploy keys的维护界面； 点击Add deploy key，参考下表填写属性值，点击Add key完成新增deploy key。更多细节参见<a href="https://docs.github.com/en/developers/overview/managing-deploy-keys#deploy-keys" target="_blank" rel="noreferrer">官网</a>。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Title</td><td>自定义</td></tr><tr><td>Key</td><td>ssh公钥</td></tr><tr><td>Allow write access(复选框)</td><td>选中</td></tr></tbody></table><ol start="3"><li>新增secret：访问vault界面，点击“Secrets”一级菜单，启用Secrets Engines，选择类别为KV，点击Next；进入Enable KV Secrets Engine的配置界面，填写Path为git，点击Enable Engine；进入当前Secrets Engine的secrets配置界面，点击Create secret，参见下表填写属性值，点击Save完成新增secret。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Path for this secret</td><td>github/user-deployments/default/readwrite</td></tr><tr><td>Secret data - key</td><td>deploykey</td></tr><tr><td>Secret data - value</td><td>ssh私钥</td></tr></tbody></table><ol start="4"><li>新增Policy：访问vault界面，点击“Policies”一级菜单，点击Create ACL policy，填写Name为git-github-user-deployments-default-readwrite，参见下文代码块填写policy，点击Create policy完成新增Policy。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;git/data/github/user-deployments/default/readwrite&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">    capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="安装argocd" tabindex="-1">安装argoCD <a class="header-anchor" href="#安装argocd" aria-hidden="true">#</a></h3><p>在宿主集群安装argoCD。</p><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到宿主集群 </span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#676E95;"># clone目标代码库(fork demo-pipeline-argoevents-tekton)，cd到相对路径cmds，执行安装脚本</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh install-argocd.sh</span></span>\n<span class="line"><span style="color:#676E95;"># 执行补丁脚本 </span></span>\n<span class="line"><span style="color:#A6ACCD;">sh patch-argocd-server.sh</span></span>\n<span class="line"></span></code></pre></div><h3 id="安装argocd-app" tabindex="-1">安装argoCD app <a class="header-anchor" href="#安装argocd-app" aria-hidden="true">#</a></h3><p><strong>替换服务地址</strong><br> 变更范围包括：argoCD app监听的源代码库地址、宿主集群的地址、运行时集群的地址，以及变更地址的关联资源，详情参见<a href="#%E6%9B%BF%E6%8D%A2%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE">替换服务地址配置</a>。</p><ol><li>根据下文模板，替换代码库地址、集群地址等，详见下文代码注释。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 目标代码库(fork demo-pipeline-argoevents-tekton)</span></span>\n<span class="line"><span style="color:#676E95;"># 批量替换argocd监听代码库地址为目标代码库</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton.git#https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">grep https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton.git -rl demo-pipeline-argoevents-tekton-1</span><span style="color:#89DDFF;">`</span></span>\n<span class="line"><span style="color:#676E95;"># 批量替换宿主集群IP地址、宿主机IP地址、vault服务端IP地址(这里vault也安装在同一台宿主机)</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#192.168.0.184#192.168.0.243#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">grep 192.168.0.184 -rl demo-pipeline-argoevents-tekton-1</span><span style="color:#89DDFF;">`</span></span>\n<span class="line"><span style="color:#676E95;"># 批量替换ingress的域名地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#119-8-58-20#119-8-99-179#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">grep 119-8-58-20 -rl demo-pipeline-argoevents-tekton-1</span><span style="color:#89DDFF;">`</span></span>\n<span class="line"><span style="color:#676E95;"># 替换argo-events中eventsource的repo信息，包括owner和names</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#lanbingcloud#zhangsan#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-pipeline-argoevents-tekton-1/argo-events/overlays/production/eventsource.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#demo-user-project#demo-user-project-1#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-pipeline-argoevents-tekton-1/argo-events/overlays/production/eventsource.yaml</span></span>\n<span class="line"><span style="color:#676E95;">#  替换argo-events中init-pipeline.yaml git-clone的代码库地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#https://github.com/lanbingcloud/demo-user-project.git#https://github.com/lanbingcloud/demo-user-project-1.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-pipeline-argoevents-tekton-1/argo-events/overlays/production/init-pipeline.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 目标代码库(fork demo-user-project)</span></span>\n<span class="line"><span style="color:#676E95;"># 替换pipeline task 拉取代码、推送代码、推送镜像的地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#https://github.com/lanbingcloud/demo-user-project.git#https://github.com/lanbingcloud/demo-user-project-1.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-user-project-1/pipelines/test-pipeline.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#git@github.com:lanbingcloud/demo-user-deployments.git#git@github.com:lanbingcloud/demo-user-deployments-1.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-user-project-1/pipelines/test-pipeline.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 替换推送镜像的github package</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#ghcr.io/lanbingcloud#ghcr.io/zhangsan#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-user-project-1/pipelines/test-pipeline.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 目标代码库(fork demo-user-deployments)</span></span>\n<span class="line"><span style="color:#676E95;"># 替换应用svc的外部访问地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#119-8-58-20#119-8-99-179#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-user-deployments-1/deployments/test/devops-sample-svc.yaml </span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>clone目标代码库，执行脚本，批量替换目标代码库的服务地址。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">sh sed-demo.sh</span></span>\n<span class="line"></span></code></pre></div><p><strong>安装根project和根app</strong></p><ol><li>使用命令安装根project和根app。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># cd到目标代码库(fork demo-pipeline-argoevents-tekton)的根目录，安装根project</span></span>\n<span class="line"><span style="color:#A6ACCD;">kubectl -nargocd apply -f project.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 安装根app</span></span>\n<span class="line"><span style="color:#A6ACCD;">kubectl -nargocd apply -f app.yaml</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>获取argoCD的初始密码，访问<a href="#%E5%AE%89%E8%A3%85%E5%9C%A8%E5%AE%BF%E4%B8%BB%E9%9B%86%E7%BE%A4%E7%9A%84argocd%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">argoCD界面</a>。观察app状态，其中root和cert-manager两个app显示同步失败：vcluster没有在argoCD注册，导致runtime-argocd-appset和runtime-appset找不到目标集群； 宿主集群没有通过vault认证，导致cert manager无法获取密钥。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># cd到目标代码库(fork demo-pipeline-argoevents-tekton)的相对路径cmds，执行脚本获取初始密码</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-argocd-admin-pwd.sh</span></span>\n<span class="line"></span></code></pre></div><h3 id="向argocd注册虚拟集群" tabindex="-1">向argoCD注册虚拟集群 <a class="header-anchor" href="#向argocd注册虚拟集群" aria-hidden="true">#</a></h3><p>用于argoCD向vcluster集群安装运行时资源，包括root app中runtime-argocd-appset和runtime-appset定义的资源。</p><ol><li>准备注册vcluster集群需要的kubeconfig文件。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到宿主集群，cd到目标代码库(fork demo-pipeline-argoevents-tekton)的相对路径cmds，执行脚本获取vcluster的kubeconfig</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-vcluster-kubeconfig.sh vcluster1</span></span>\n<span class="line"><span style="color:#676E95;"># 修改kubeconfig文件，保存到宿主机指定目录</span></span>\n<span class="line"><span style="color:#A6ACCD;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">clusters:</span></span>\n<span class="line"><span style="color:#A6ACCD;">- cluster:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    certificate-authority-data: ...</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 修改为:&lt;宿主机内网IP:vcluster1的svc nodePort&gt;</span></span>\n<span class="line"><span style="color:#A6ACCD;">    server: https://192.168.0.243:31543    </span></span>\n<span class="line"><span style="color:#A6ACCD;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">contexts:</span></span>\n<span class="line"><span style="color:#A6ACCD;">- context:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    cluster: </span><span style="color:#C792EA;">local</span></span>\n<span class="line"><span style="color:#A6ACCD;">    namespace: default</span></span>\n<span class="line"><span style="color:#A6ACCD;">    user: user</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">#自定义名称</span></span>\n<span class="line"><span style="color:#A6ACCD;">  name: Default31543  </span></span>\n<span class="line"><span style="color:#676E95;">#自定义名称 </span></span>\n<span class="line"><span style="color:#A6ACCD;">current-context: Default31543  </span></span>\n<span class="line"><span style="color:#A6ACCD;">...</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>使用argocd命令注册vcluster。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;"># 切换到宿主集群，修改argocd server的svc类型为NodePort（步骤略）</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 执行cmds目录下的get-argocd-admin-pwd.sh脚本获取argoCD初始密码</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-argocd-admin-pwd.sh</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 使用命令行登录argocd：argocd login &lt;内网IP&gt;:&lt;argocd server svc的nodeport&gt;</span></span>\n<span class="line"><span style="color:#A6ACCD;">argocd login 192.168.0.243:30070</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 切换到vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">export KUBECONFIG=/opt/vcluster/kubeconfig-31543.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 使用命令行注册vcluster：argocd cluster add &lt;cluster-name&gt; --kubeconfig=&lt;kubeconfig.yaml&gt;</span></span>\n<span class="line"><span style="color:#A6ACCD;">argocd cluster add Default31543 --kubeconfig=/opt/vcluster/kubeconfig-31543.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 验证vcluster是否注册成功</span></span>\n<span class="line"><span style="color:#A6ACCD;">argocd cluster list</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><ol start="3"><li>访问<a href="#%E5%AE%89%E8%A3%85%E5%9C%A8%E5%AE%BF%E4%B8%BB%E9%9B%86%E7%BE%A4%E7%9A%84argocd%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">安装在宿主集群的argoCD界面</a>，等待argoCD自动同步，直到root app状态更新为已同步。如果想立即验证效果，删除runtime-appset和runtime-argocd-appset，等待argoCD重新生成资源，观察root app状态更新为已同步。</li></ol><h3 id="向vault同步宿主集群和运行时集群的认证信息" tabindex="-1">向vault同步宿主集群和运行时集群的认证信息 <a class="header-anchor" href="#向vault同步宿主集群和运行时集群的认证信息" aria-hidden="true">#</a></h3><p><strong>同步宿主集群的认证信息</strong><br> 用于安装在宿主集群上的资源获取存储在vault的密钥。</p><ol><li>准备配置宿主集群认证需要的信息：包括集群的CA证书、授权sa的token、集群host地址。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到宿主集群，cd到目标代码库(fork demo-pipeline-argoevents-tekton)的相对路径cmds，执行脚本get-cluster-ca.sh获取CA证书</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-cluster-ca.sh </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">KUBECONFIG</span></span>\n<span class="line"><span style="color:#676E95;"># 执行get-vault-auth-token.sh获取token</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-vault-auth-token.sh</span></span>\n<span class="line"><span style="color:#676E95;"># 查看kubeconfig文件获取host地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">cat </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>启用kubernetes认证方法：访问vault界面，点击&quot;Access&quot;一级菜单,进入Authentication Methods的配置界面，点击Enable new method，选择类别为Kubernetes，点击Next; 进入Enable Kubernetes Authentication Method的配置界面，设置Path为host-cluster，点击Enable Method; 进入Configure Kubernetes的配置界面，参见下表填写属性值，点击Save完成启用kubernetes认证方法。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Kubernetes host</td><td>宿主集群的host地址</td></tr><tr><td>Kubernetes CA Certificate</td><td>宿主集群的CA证书</td></tr><tr><td>Token Reviewer JWT</td><td>宿主集群的sa token</td></tr></tbody></table><ol start="3"><li>新增特定kubernetes认证方法的role：访问vault界面，点击&quot;Access&quot;一级菜单,进入Authentication Methods的配置界面，点击Path为host-cluster的认证方法链接； 进入role的维护界面，点击Create role，参见下表填写属性值，点击Save完成新增role。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Name</td><td>cert-manager</td></tr><tr><td>Bound service account names</td><td>default</td></tr><tr><td>Bound service account namespaces</td><td>cert-manager</td></tr><tr><td>Generated Token&#39;s Policies</td><td>pki-root</td></tr></tbody></table><ol start="4"><li>验证cert-manager获取密钥：访问<a href="#%E5%AE%89%E8%A3%85%E5%9C%A8%E5%AE%BF%E4%B8%BB%E9%9B%86%E7%BE%A4%E7%9A%84argocd%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">安装在宿主集群的argoCD界面</a>，等待argoCD自动同步，直到cert-manager app状态更新为已同步。如果想立即验证效果，删除以下资源：类型为SecretStore的cert-manager-secretstore、类型为ExternalSecret的root-issuer、类型为ClusterIssuer的org-issuer，等待argoCD重新生成资源，观察cert-manager app的状态更新为已同步。</li></ol><p><strong>同步vcluster的认证信息</strong><br> 用于安装在vcluster集群上的资源获取存储在vault的密钥。</p><ol><li>准备配置vcluster集群认证需要的信息。包括：集群的CA证书、授权sa的token、集群host地址。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到vcluster集群，cd到目标代码库(fork demo-pipeline-argoevents-tekton)的相对路径cmds，执行脚本get-cluster-ca.sh获取CA证书</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=/opt/vcluster/kubeconfig-31543.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-cluster-ca.sh </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">KUBECONFIG</span></span>\n<span class="line"><span style="color:#676E95;"># 执行get-vault-auth-token.sh获取token</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-vault-auth-token.sh</span></span>\n<span class="line"><span style="color:#676E95;"># 查看kubeconfig文件获取host地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">cat /opt/vcluster/kubeconfig-31543.yaml</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>启用kubernetes认证方法：访问vault界面，点击&quot;Access&quot;一级菜单,进入Authentication Methods的配置界面，点击Enable new method，选择类别为Kubernetes，点击Next; 进入Enable Kubernetes Authentication Method的配置界面，设置Path为pipeline1-cluster，点击Enable Method; 进入Configure Kubernetes的配置界面，参见下表填写属性值，点击Save完成启用kubernetes认证方法。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Kubernetes host</td><td>vcluster的host地址</td></tr><tr><td>Kubernetes CA Certificate</td><td>vcluster的CA证书</td></tr><tr><td>Token Reviewer JWT</td><td>vcluster的sa token</td></tr></tbody></table><ol start="3"><li>新增特定kubernetes认证方法的role：访问vault界面，点击&quot;Access&quot;一级菜单,进入Authentication Methods的配置界面，点击Path为pipeline1-cluster的认证方法链接； 进入role的维护界面，点击Create role，参见下表填写属性值，点击Save完成新增role。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Name</td><td>argo-events-sa</td></tr><tr><td>Bound service account names</td><td>argo-events-sa</td></tr><tr><td>Bound service account namespaces</td><td>argo-events</td></tr><tr><td>Generated Token&#39;s Policies</td><td>git-github-user-project-argoevents-webhook-access</td></tr><tr><td>Name</td><td>user-pipelines</td></tr><tr><td>Bound service account names</td><td>default</td></tr><tr><td>Bound service account namespaces</td><td>user-pipelines</td></tr><tr><td>Generated Token&#39;s Policies</td><td>git-github-user-deployments-default-readwrite<br>repo-github-container-lanbing-default-readwrite</td></tr></tbody></table><ol start="4"><li>验证argo-events获取密钥：访问<a href="#%E5%AE%89%E8%A3%85%E5%9C%A8vcluster%E9%9B%86%E7%BE%A4%E7%9A%84argocd%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">安装在vcluster集群的argoCD界面</a>，等待argoCD自动同步，直到argo-events app状态更新为已同步。如果想立即验证效果，删除以下资源：类型为SecretStore的webhook-secretstore、类型为ExternalSecret的github-access、类型为EventSource的webhook，等待argoCD重新生成资源，观察argo-events app的状态更新为已同步。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到vcluster集群，cd到目标代码库(fork demo-pipeline-argoevents-tekton)的相对路径cmds，执行脚本获取初始密码</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-argocd-admin-pwd.sh</span></span>\n<span class="line"></span></code></pre></div><h3 id="执行流水线" tabindex="-1">执行流水线 <a class="header-anchor" href="#执行流水线" aria-hidden="true">#</a></h3><p>fork 代码库demo-user-project，并向目标代码库提交代码（例如修改pom文件中项目的版本），<a href="#tekton-dashboard%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">访问tekton-dashboard</a>观察流水线已经自动执行。 <img src="/docs/assets/CI-10.7811ea19.jpg" alt="directive syntax graph"></p><h2 id="附件" tabindex="-1">附件 <a class="header-anchor" href="#附件" aria-hidden="true">#</a></h2><h3 id="参考链接" tabindex="-1">参考链接 <a class="header-anchor" href="#参考链接" aria-hidden="true">#</a></h3><p><strong>Github DEMO示例：</strong><br><a href="https://github.com/lanbingcloud/demo-vcluster-tekton-argoevents-vaultagent-externalsecrets" target="_blank" rel="noreferrer">https://github.com/lanbingcloud/demo-vcluster-tekton-argoevents-vaultagent-externalsecrets</a><br><a href="https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton" target="_blank" rel="noreferrer">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton</a></p><p><strong>B站讲解视频：</strong><br><a href="https://www.bilibili.com/video/BV1yP4y1U7mS/" target="_blank" rel="noreferrer">https://www.bilibili.com/video/BV1yP4y1U7mS/</a><br><a href="https://www.bilibili.com/video/BV1Fm4y1A7qL/" target="_blank" rel="noreferrer">https://www.bilibili.com/video/BV1Fm4y1A7qL/</a></p><h3 id="安装在宿主集群的argocd访问地址" tabindex="-1">安装在宿主集群的argoCD访问地址 <a class="header-anchor" href="#安装在宿主集群的argocd访问地址" aria-hidden="true">#</a></h3><p>协议：https<br> 地址：来自production/patch/ingress-argocd.yaml的hosts<br> 端口：来自production/traefik-app.yaml的websecure.nodePort<br> 示例：<a href="https://argocd.119-8-99-179.nip.io:30443" target="_blank" rel="noreferrer">https://argocd.119-8-99-179.nip.io:30443</a></p><h3 id="安装在vcluster集群的argocd访问地址" tabindex="-1">安装在vcluster集群的argoCD访问地址 <a class="header-anchor" href="#安装在vcluster集群的argocd访问地址" aria-hidden="true">#</a></h3><p>协议：https<br> 地址：来自runtimes/pipeline1-runtime/production/patch/ingress-argocd.yaml的hosts<br> 端口：来自production/traefik-app.yaml的websecure.nodePort<br> 示例：<a href="https://argocd.pipeline1.119-8-99-179.nip.io:30443" target="_blank" rel="noreferrer">https://argocd.pipeline1.119-8-99-179.nip.io:30443</a></p><h3 id="tekton-dashboard访问地址" tabindex="-1">tekton-dashboard访问地址 <a class="header-anchor" href="#tekton-dashboard访问地址" aria-hidden="true">#</a></h3><p>协议：http<br> 地址：来自tekton/overlays/production/dashboard-ingress.yaml的host<br> 端口：来自production/traefik-app.yaml的web.nodePort<br> 示例：<a href="http://tekton.pipeline1.119-8-99-179.nip.io:30080" target="_blank" rel="noreferrer">http://tekton.pipeline1.119-8-99-179.nip.io:30080</a></p><h3 id="预置的证书和私钥" tabindex="-1">预置的证书和私钥 <a class="header-anchor" href="#预置的证书和私钥" aria-hidden="true">#</a></h3><p><strong>tls.crt</strong><br> ----BEGIN CERTIFICATE----- MIIC+zCCAeOgAwIBAgIJAMv/rvOaPioGMA0GCSqGSIb3DQEBCwUAMBQxEjAQBgNV BAMMCWJsdXppbi1jYTAeFw0yMjA2MjEwMjEzNTBaFw00OTExMDYwMjEzNTBaMBQx EjAQBgNVBAMMCWJsdXppbi1jYTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoC ggEBAKYqCk8qyWNUsvLt/61ie2CGFvdwFLdWCwfk+be0U9wp7Lq6+RR+KERQF3/E G15uRpZPreVO/YJpTetod5RWkJeIMho1eutyhJFdaWWxA1G7oyxL/duWJWGCCd2v VleQD7JjueDC5AXKFQMXBbFcMUB9dv/mPfI/1puMHQbyfvdIsdaTH9gpJGPCl2a+ csDuI/fZJH0yJbWpDbCOhm1JmJ35GweNFIWfkluNU2K4QyH5JMk5dDcLyE4pDkdc MZbyhsadR4ndNbsvj8xhWv4yMXuVcSbkGekhCuzxkUv3RXGLCPgETIbf+8daX3NW o5T69alrFqRzB0NFZgbTHN60vrcCAwEAAaNQME4wHQYDVR0OBBYEFKw6dUhhxRxr DVt3qrZ5l2cWYykmMB8GA1UdIwQYMBaAFKw6dUhhxRxrDVt3qrZ5l2cWYykmMAwG A1UdEwQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAB2Z94Jbvq9pT4UfjFcV22Bf zF0+jPifVBe3btJdplc0ItvaQZqVWQ8CC5/lz8Xe0bK3rc95hKqxaZERsvjSqmU/ LhlOlhHrE1Zm4fNuh+svEMFnUnk98wnUMeBed897hDRKhpaP6sX88rRdhanvBoja rKLTdjUcbrAT9XeTkVwBSSBG5itGUaEeUmbITZlu9juI031W8Wl28i3dRaWvTDGY /e+FEqu7bz9Pkfu0DKEGpINdFfpl6WV3IbMheORPZM5QNVFkybqgp/ryrRFuVM/U nT4uAguLdb0yB/NhUh+9iwpxkSv5/o547/nQ8JLJHotJkJ7HaXdMKliL3xvr4Qw= -----END CERTIFICATE-----</p><p><strong>tls.key</strong><br> -----BEGIN RSA PRIVATE KEY----- MIIEpAIBAAKCAQEApioKTyrJY1Sy8u3/rWJ7YIYW93AUt1YLB+T5t7RT3Cnsurr5 FH4oRFAXf8QbXm5Glk+t5U79gmlN62h3lFaQl4gyGjV663KEkV1pZbEDUbujLEv9 25YlYYIJ3a9WV5APsmO54MLkBcoVAxcFsVwxQH12/+Y98j/Wm4wdBvJ+90ix1pMf 2CkkY8KXZr5ywO4j99kkfTIltakNsI6GbUmYnfkbB40UhZ+SW41TYrhDIfkkyTl0 NwvITikOR1wxlvKGxp1Hid01uy+PzGFa/jIxe5VxJuQZ6SEK7PGRS/dFcYsI+ARM ht/7x1pfc1ajlPr1qWsWpHMHQ0VmBtMc3rS+twIDAQABAoIBAHV4qykk2pM6wfg0 gdkWEps+sOXlev/R+KJwIorZFaBEk3O/02/FcLo61SIihibQV17Und/LZDXaNJgE luVr/XTjeGhG/suNfmM2Ytjdt7cErGsYnjOrhmnVARyUZLoqwq4fCr33ijT9lLVG hWPKBZfOG172azzkHNiCydKrhU9UFVDnyhYPKFyMK6ufqessxZZBmIAGkD+17shL kHgRPepyognblzZW634CpL2vG6p5PwI8DaiM3CrGEYCNyVFoCDMoiUSqIvISSO/L v/ZpNw0NginN4NT6ZXFS+HTERrgrz4q0HtoI8FDYJjcao6LevtKKGfbCMjtbutJe zwacjoECgYEA2F/v6ZZx1OveCw6J9HNxwxwQVNUtTZlsyxrRQk8PHYWkVgPkVIMx BmqVHh98F+4MHZnERi1Yd2bN8FtS3XJv0g6cKnXpCwoscGyNLD+IHjXWK9/WI+74 yyt5kjWQWrlL0cuIrd+ekPAct1lW4aboZSSkeSXotJvNJC8avQ5SwkcCgYEAxJgj GJB6eV/G+bQEjAi2sxphRe8Oz3TC6O30eJa3MBWyspnlK1KxMbfqBqCA6yqdvghj QZghONwHFgRwtV72EO4augj+qsSFWWanhGAnBzydv0fk53DYhB3k8j+BqY/8g+VR ghB7MwwPffsCG3RH6GidFX/53OljI2tqILTvaBECgYEA1Kx3g4D8Iew0M2n27u8J wlyzMK7X+I31AS06wZIzqTDSdjkdFHRem4/nQdRwhJTWE8IvyUqIydOiV71rlX4F qtHxbUq35MH7LAWGPRe1EvyXpkg8ktUwdYIl3DAJ0yKOA4eqsDw7/voDP7PwUZtc kQ2THADG2b7Jw+cIwQpzDcECgYAZYLpHFX95448/9KkRmp5bCHC+Iln7FcuDXhRM 7MfBAUwMGimnKgmNrXwcVuPNd7bdLSAC+6xuNpkDkpcqEpQZI2N32Glnie7c14+Q WwkuufhzFMjLx5lrlKBVVTVbuiaSsCuRaqc8s7XcQWbIPH571eVRPS/4AHi3vcn5 ZuHwwQKBgQCg+6g8oZJMIYIDxpKnFD6LVicL1aqqbPKBVkGQctwm2rx00C7feeXh PvGDon8H4FdLTFRfMfSFV7Prnk2vzFFFRz5U3JVxsK77FkigEiV7WAaxM7gW5+2N zo9O7481Eqd1OxofiLfSJHckDNORZgNvBLBZRoPERNuLVxtacIYxFA== -----END RSA PRIVATE KEY-----</p><h3 id="替换服务地址配置" tabindex="-1"><strong>替换服务地址配置</strong> <a class="header-anchor" href="#替换服务地址配置" aria-hidden="true">#</a></h3><h4 id="代码库：demo-pipeline-argoevents-tekton" tabindex="-1">代码库：demo-pipeline-argoevents-tekton <a class="header-anchor" href="#代码库：demo-pipeline-argoevents-tekton" aria-hidden="true">#</a></h4><p>fork demo-pipeline-argoevents-tekton代码库，修改目标代码库的服务地址。</p><h5 id="替换监听的代码库地址" tabindex="-1">替换监听的代码库地址 <a class="header-anchor" href="#替换监听的代码库地址" aria-hidden="true">#</a></h5><p>相对路径：app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/{{runtime}}</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/cert-manager-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cert-manager/overlays/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-argocd-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd/overlays/production</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/vcluster-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vclusters/{{cluster}}</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">production/patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：vclusters/vcluster1/vcluster1-patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vclusters/vcluster1/vcluster1-patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/pipeline1-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/pipeline1-runtime/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/argo-events-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argo-events/overlays/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/user-namespaces-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user-namespaces</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/tekton-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tekton/overlays/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/pipeline1-runtime/production/patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换宿主集群ip地址、宿主机ip、vault服务端ip" tabindex="-1">替换宿主集群IP地址、宿主机IP、vault服务端IP <a class="header-anchor" href="#替换宿主集群ip地址、宿主机ip、vault服务端ip" aria-hidden="true">#</a></h5><p>相对路径：vclusters/vcluster1/vcluster1-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        vcluster:</span></span>\n<span class="line"><span style="color:#C3E88D;">          image: rancher/k3s:v1.21.13-k3s1</span></span>\n<span class="line"><span style="color:#C3E88D;">        syncer:</span></span>\n<span class="line"><span style="color:#C3E88D;">          extraArgs:</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">          - --tls-san=192.168.0.243   # 替换为宿主机的内网IP</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：argo-events/overlays/production/secretstore.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">provider</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">vault</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;"># 替换为vault服务端的IP和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://192.168.0.243:31820</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">git</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">v2</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：cert-manager/overlays/production/secretstore.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">provider</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">vault</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;"># 替换为vault服务端的IP和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://192.168.0.243:31820</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pki</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">v2</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/metallb-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        configInline:</span></span>\n<span class="line"><span style="color:#C3E88D;">          address-pools:</span></span>\n<span class="line"><span style="color:#C3E88D;">          - name: default</span></span>\n<span class="line"><span style="color:#C3E88D;">            protocol: layer2</span></span>\n<span class="line"><span style="color:#C3E88D;">            addresses:</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">            - 192.168.0.243-192.168.0.243    # 替换为宿主机的内网IP</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">generators</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">list</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">elements</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">runtime</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pipeline1-runtime</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标集群的IP地址和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">clusterURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://192.168.0.243:31543</span><span style="color:#A6ACCD;">    </span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/{{runtime}}</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">destination</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{{clusterURL}}</span><span style="color:#89DDFF;">&#39;</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/vault-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        global:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: false</span></span>\n<span class="line"><span style="color:#C3E88D;">        injector:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: true</span></span>\n<span class="line"><span style="color:#C3E88D;">          authPath: auth/host-cluster</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">          externalVaultAddr: http://192.168.0.243:31820  #替换为vault服务的IP和端口</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-argocd-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">generators</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">list</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">elements</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">runtime</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pipeline1-runtime-argocd</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标集群的IP地址和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">clusterURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://192.168.0.243:31543</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd/overlays/production</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">destination</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{{clusterURL}}</span><span style="color:#89DDFF;">&#39;</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/vault-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        global:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: false</span></span>\n<span class="line"><span style="color:#C3E88D;">        injector:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: true</span></span>\n<span class="line"><span style="color:#C3E88D;">          authPath: auth/pipeline1-cluster</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">          externalVaultAddr: http://192.168.0.243:31820  #替换为vault服务的IP和端口</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换ingress的域名地址" tabindex="-1">替换ingress的域名地址 <a class="header-anchor" href="#替换ingress的域名地址" aria-hidden="true">#</a></h5><p>相对路径：argo-events/overlays/production/eventsource.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">github</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">user-project</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">webhook</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">endpoint</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/user-project</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">12000</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">method</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">POST</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">http://webhook.pipeline1.119-8-99-179.nip.io:30080</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：argo-events/overlays/production/ingress-webhook-eventsource.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">networking.k8s.io/v1</span></span>\n<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Ingress</span></span>\n<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">webhook-eventsource</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argo-events</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">webhook.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/patch/ingress-argocd.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/patch/ingress-argocd.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：tekton/overlays/production/dashboard-ingress.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tekton.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换argo-events-eventsource的repo信息" tabindex="-1">替换argo-events eventsource的repo信息 <a class="header-anchor" href="#替换argo-events-eventsource的repo信息" aria-hidden="true">#</a></h5><p>相对路径：argo-events/overlays/production/eventsource.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">github</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">user-project</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">repositories</span><span style="color:#89DDFF;">:</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">owner</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lanbingcloud</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;"># 替换为eventsource监听代码库的owner</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">names</span><span style="color:#89DDFF;">:</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-user-project-1</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;"># 替换为eventsource监听代码库的name</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换init-pipeline中git-clone任务的代码库地址" tabindex="-1">替换init-pipeline中git clone任务的代码库地址 <a class="header-anchor" href="#替换init-pipeline中git-clone任务的代码库地址" aria-hidden="true">#</a></h5><p>相对路径：argo-events/overlays/production/init-pipeline.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">triggers</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init-pipeine</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">k8s</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">operation</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">create</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">resource</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#F07178;">pipelineSpec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F07178;">taskRef</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ClusterTask</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F07178;">workspaces</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">output</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">workspace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source-volume</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">subPath</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">$(params.REVISION)</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">url</span></span>\n<span class="line"><span style="color:#89DDFF;">                      </span><span style="color:#676E95;"># 替换为目标代码库地址（fork demo-user-project代码库）</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-user-project-1.git</span></span>\n<span class="line"></span></code></pre></div><h4 id="代码库：demo-user-project" tabindex="-1">代码库：demo-user-project <a class="header-anchor" href="#代码库：demo-user-project" aria-hidden="true">#</a></h4><p>fork demo-user-project代码库，修改目标代码库。 替换流水线task拉取代码、推送代码、推送镜像的地址。</p><p>相对路径：pipelines/test-pipeline.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">pipelineSpec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone-sourcecode</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">url</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库（fork demo-user-project）的地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/lanbingcloud/demo-user-project-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone-deployment</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">url</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库(fork demo-user-deployments)的地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git@github.com:lanbingcloud/demo-user-deployments-1.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">image-build</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">runAfter</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mvn-build</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">taskRef</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kaniko</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ClusterTask</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">workspaces</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">workspace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source-volume</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">IMAGE</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为github镜像仓库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ghcr.io/zhangsan/devops-sample:0.0.1-$(tasks.git-clone-sourcecode.results.commit)</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">DOCKERFILE</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./sourcecode/Dockerfile</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">CONTEXT</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./sourcecode</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">manifest-update</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">runAfter</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">image-build</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">taskRef</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-cli</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ClusterTask</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">workspaces</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">workspace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source-volume</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">GIT_SCRIPT</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span></span>\n<span class="line"><span style="color:#C3E88D;">          cd deployment</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 使用sed字符串替换镜像地址 </span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">sed -i -e &quot;s#ghcr.io/zhangsan/devops-sample.*#$(tasks.image-build.results.IMAGE_URL)#g&quot; deployments/test/devops-sample.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">git add deployments/test/devops-sample.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">git commit -a -m &quot;automatic update by pipeline bot</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">$(tasks.image-build.results.IMAGE_URL)&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">git push origin HEAD:$(params.REVISION) --force</span></span>\n<span class="line"></span></code></pre></div><h4 id="代码库：demo-user-deployments" tabindex="-1">代码库：demo-user-deployments <a class="header-anchor" href="#代码库：demo-user-deployments" aria-hidden="true">#</a></h4><p>fork demo-user-deployments代码库，修改目标代码库。替换应用svc的外部访问地址。</p><p>相对路径：deployments/test/devops-sample-svc.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">networking.k8s.io/v1</span></span>\n<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Ingress</span></span>\n<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ks-sample-dev</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机外网IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">devops-sample.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"></span></code></pre></div>',171)];const t=s(e,[["render",function(s,l,p,e,t,c){return n(),a("div",null,o)}]]);export{p as __pageData,t as default};
