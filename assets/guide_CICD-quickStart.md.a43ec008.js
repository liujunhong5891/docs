import{_ as s,a as n}from"./chunks/CI-10.a8b2df40.js";import{_ as a,o as l,c as p,a as o}from"./app.2a4bdb74.js";const e=JSON.parse('{"title":"","description":"","frontmatter":{"footer":false,"outline":"deep"},"headers":[{"level":2,"title":"概览","slug":"概览","link":"#概览","children":[]},{"level":2,"title":"准备","slug":"准备","link":"#准备","children":[]},{"level":2,"title":"实施步骤","slug":"实施步骤","link":"#实施步骤","children":[{"level":3,"title":"维护密钥","slug":"维护密钥","link":"#维护密钥","children":[]},{"level":3,"title":"安装 ArgoCD","slug":"安装-argocd","link":"#安装-argocd","children":[]},{"level":3,"title":"安装 ArgoCD app","slug":"安装-argocd-app","link":"#安装-argocd-app","children":[]},{"level":3,"title":"注册 vcluster","slug":"注册-vcluster","link":"#注册-vcluster","children":[]},{"level":3,"title":"同步集群认证","slug":"同步集群认证","link":"#同步集群认证","children":[]},{"level":3,"title":"执行流水线","slug":"执行流水线","link":"#执行流水线","children":[]}]},{"level":2,"title":"附件","slug":"附件","link":"#附件","children":[{"level":3,"title":"参考链接","slug":"参考链接","link":"#参考链接","children":[]},{"level":3,"title":"安装在 Kubernetes 集群的 ArgoCD 访问地址","slug":"安装在-kubernetes-集群的-argocd-访问地址","link":"#安装在-kubernetes-集群的-argocd-访问地址","children":[]},{"level":3,"title":"安装在 vcluster 集群的 ArgoCD 访问地址","slug":"安装在-vcluster-集群的-argocd-访问地址","link":"#安装在-vcluster-集群的-argocd-访问地址","children":[]},{"level":3,"title":"Tekton dashboard 访问地址","slug":"tekton-dashboard-访问地址","link":"#tekton-dashboard-访问地址","children":[]},{"level":3,"title":"替换服务地址配置","slug":"替换服务地址配置","link":"#替换服务地址配置","children":[]}]}],"relativePath":"guide/CICD-quickStart.md"}'),t={name:"guide/CICD-quickStart.md"},c=[o('<h2 id="概览" tabindex="-1">概览 <a class="header-anchor" href="#概览" aria-hidden="true">#</a></h2><p>近几年随着以 Kubernetes 为核心的云原生技术和工具的发展，开源社区涌现出大量可以实现 CI/CD 的 Kubernetes 原生工具，但我们在引入这些工具的过程中往往会发现，单一工具难以完成所有过程，通常需要多种工具的协同工作才能支撑全流程的 CI/CD 场景，那么如何将多个异构开源工具集成起来，并打通这些工具的认证、权限、数据、流程等壁垒，就成为我们在引入这些工具过程中最大的挑战。本文会用一个 demo 向大家展示，如何通过集成多个 Kubernetes 原生的开源工具，构建一个可以通过代码提交触发的 CI/CD 流水线，完成拉取代码、编译、构建镜像、推送镜像、部署等几个关键任务，以最简化的形式实现软件项目的持续交付。</p><p><img src="'+s+'" alt="directive syntax graph"></p><p>如上图所示，本 demo 的基础环境是由一个 Kubernetes 集群和一个 Vault 实例组成（demo 中没有提供这两个工具的自动化安装程序，需要大家自行安装）。其中，Kubernetes 集群承载了所有与提供 CI/CD 能力相关的工具，Vault 则是为 Kubernetes 集群承载的各个工具提供密钥的存取服务。</p><p>本 demo 是采用了 GitOps 的管理方法，GitOps 提倡将项目所有的配置声明都存储在版本控制系统中。在本 demo 中，所有运行在 Kubernetes 中工具的安装脚本和参数配置是存储在 GitHub 中，而工具运行过程所需的密钥数据则是通过 Vault 进行存储和管理。Vault 除了能提供密钥的版本管理能力外，还能提供多样的认证方法、灵活的权限控制和密钥提取方式，同时可以和 Kubernetes 无缝集成，相较于 GitHub 更适合与 Kubernetes 及其原生工具协同工作。</p><p>本 demo 展示了流水线和持续部署的运行环境。为了用尽量少的资源获得更好的隔离性，我们采用了在物理集群中划分虚拟集群的方式来实现不同环境之间的隔离。上图中的 vcluster 就是一种虚拟集群的实现方式，demo 中所有跟流水线运行相关的核心工具都在流水线运行集群中（vcluster1-pipeline） 、跟部署运行相关的工具则在部署运行集群中（vcluster2-deployment） 。</p><p>除了密钥数据外，其他所有运行在 Kubernetes 中的工具均是通过 ArgoCD 进行部署和管理的。ArgoCD 会监听 GitHub 中的配置清单，向物理集群中部署CertManager、Metallb、Traefik、VaultAgent、ExternalSecrets、以及两个 vcluster，其中，CertManager 会为 Kubernetes 中各个工具所暴露的 HTTPS 服务自动签发证书；Metallb 是为 Kubernetes service 提供 LoadBalancer；Traefik 同时为物理集群和虚拟集群提供 Ingress 服务；VaultAgent 和 ExternalSecrets 则提供了从 Vault 中加载密钥到 Kubernetes 集群的不同方式。</p><p>当 ArgoCD 在物理集群部署好两个 vcluster 实例之后，会继续在这两个 vcluster 中分别部署一个 ArgoCD 实例，运行在 vcluster 中的其他工具是由这个内部的 ArgoCD 进行部署和管理的。在流水线运行集群（vcluster1-pipeline）中，包括工具：ArgoEvents、Tekton、以及 VaultAgent 和 ExternalSecrets，其中 ArgoEvents 负责监听 GitHub 上的 Webhook 回调并触发流水线，Tekton 则负责流水线的解析和执行。在部署运行集群中（vcluster2-deployment），只需要部署 ArgoCD 。</p><p>我们会将需要被集成的项目代码存放到 GitHub 中，同时将流水线清单、编译脚本、Dockerfile等文件放入同一个代码库。当我们向这个代码库推送变更（git push）时，GitHub 会发送一个回调给 ArgoEvents，ArgoEvents 根据回调内容在 Kubernetes 集群中创建相应的流水线资源，Tekton 再将流水线转为多个 Kubernetes POD去执行。</p><p>流水线中编排的任务包括：clone 代码、编译构建、构建并推送镜像、更新部署资源的镜像地址、应用部署（接收部署通知）。当流水线更新镜像地址之后，部署运行环境中 ArgoCD app 的部署状态一旦变更，通过协同 ArgoCD Notifications 和 ArgoEvents，ArgoCD Notifications 回调流水线运行环境中的 Webhook 向流水线发送消息，流水线中的部署任务捕获并解析消息，进一步判断部署状态是挂起、失败或者成功。可以通过 Kubectl CLI 或 Tekton dashboard 跟踪流水线中所有任务的执行过程。</p><h2 id="准备" tabindex="-1">准备 <a class="header-anchor" href="#准备" aria-hidden="true">#</a></h2><p>以下工具有多种安装方式，下文只是其中一种。</p><p><strong>安装一个 Kubernetes 集群</strong><br> 通过命令安装 K3s。为了让 K3s 安装成功，请确保宿主机已连通外网。</p><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 替换 tls-san 值为宿主机IP</span></span>\n<span class="line"><span style="color:#A6ACCD;">curl -sfL https://get.k3s.io </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> INSTALL_K3S_VERSION=v1.21.14+k3s1 sh -s - server --disable servicelb --disable traefik --disable metrics-server --tls-san 119.8.99.179</span></span>\n<span class="line"><span style="color:#A6ACCD;">cp /etc/rancher/k3s/k3s.yaml </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/k3s-config</span></span>\n<span class="line"><span style="color:#A6ACCD;">cp /etc/rancher/k3s/k3s.yaml </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"></span></code></pre></div><p><strong>安装一个 Vault 实例</strong><br> 支持安装包、Helm、源码、Docker 等安装方式。下文使用安装包安装。</p><ol><li>下载并配置 Vault ，参见<a href="https://developer.hashicorp.com/vault/docs/install#installing-vault" target="_blank" rel="noreferrer">官网</a>。</li><li>更新默认配置文件，启动 Vault 。<div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># config.hcl的默认路径：/opt/vault/config</span></span>\n<span class="line"><span style="color:#A6ACCD;">cat config.hcl</span></span>\n<span class="line"><span style="color:#A6ACCD;">storage </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">raft</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">     </span></span>\n<span class="line"><span style="color:#A6ACCD;">   path    = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/opt/vault/data</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">   node_id = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node1</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#676E95;">#  更新address端口为预置端口</span></span>\n<span class="line"><span style="color:#A6ACCD;">listener </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tcp</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">     </span></span>\n<span class="line"><span style="color:#A6ACCD;">   address     = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">0.0.0.0:31820</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">   tls_disable = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;">disable_mlock = </span><span style="color:#82AAFF;">true</span></span>\n<span class="line"><span style="color:#676E95;">#  更新api_addr和cluster_addr的端口为预置端口</span></span>\n<span class="line"><span style="color:#A6ACCD;">api_addr = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://0.0.0.0:31820</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">   </span></span>\n<span class="line"><span style="color:#A6ACCD;">cluster_addr = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://192.168.0.243:31821</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">ui = </span><span style="color:#82AAFF;">true</span></span>\n<span class="line"></span></code></pre></div></li></ol><p><strong>在宿主机上安装 ArgoCD 命令行</strong><br> 下载并配置 ArgoCD 命令行，参见<a href="https://argo-cd.readthedocs.io/en/stable/cli_installation/#download-with-curl" target="_blank" rel="noreferrer">官网</a>。</p><p><strong>Fork GitHub demo 代码库</strong></p><ul><li>配置 CI 基础环境和流水线（简称FC）：<a href="https://github.com/lanbingcloud/demo-cicd-tekton-argocd.git" target="_blank" rel="noreferrer">demo-cicd-tekton-argocd</a></li><li>存储应用源码和流水线（简称FP）：<a href="https://github.com/lanbingcloud/demo-user-project" target="_blank" rel="noreferrer">demo-user-project</a></li><li>存储应用部署的资源文件（简称FD）：<a href="https://github.com/lanbingcloud/demo-user-deployments" target="_blank" rel="noreferrer">demo-user-deployments</a></li></ul><h2 id="实施步骤" tabindex="-1">实施步骤 <a class="header-anchor" href="#实施步骤" aria-hidden="true">#</a></h2><ol><li><strong>维护密钥</strong>：在 Vault 中维护本 demo 所需密钥及其访问策略。</li><li><strong>安装ArgoCD</strong>：在 Kubernetes 集群上安装 ArgoCD 。</li><li><strong>安装ArgoCD app</strong>：在 Kubernetes 集群的 ArgoCD 上 ，创建根 project 和根 app ，ArgoCD 将通过 <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/#app-of-apps-pattern" target="_blank" rel="noreferrer">App of Apps</a> 的方式在 Kubernetes 集群中部署工具，详情参见<a href="#%E6%A6%82%E8%A7%88">概览</a>。</li><li><strong>注册 vcluster</strong>： 向 ArgoCD 注册 vcluster 集群，用于 ArgoCD 在 vcluster 集群中安装工具。</li><li><strong>同步集群认证</strong>: 在 Vault 中配置 Kubernetes 集群和 vcluster 集群的认证，用于 Kubernetes 集群和 vcluster 集群中的工具获取 Vault 密钥。</li><li><strong>执行流水线</strong>：向<a href="#%E5%87%86%E5%A4%87">代码库 FP</a> 推送代码，触发流水线自动执行。</li></ol><h3 id="维护密钥" tabindex="-1">维护密钥 <a class="header-anchor" href="#维护密钥" aria-hidden="true">#</a></h3><p><strong>CertManager</strong></p><p>在 Vault 中维护 TLS 私钥和证书，用于 CertManager 签发证书。</p><ol><li>新增私钥和自签证书：执行命令，应答CSR(Certificate Signing Request)提示信息，生成私钥和证书。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">openssl req \\</span></span>\n<span class="line"><span style="color:#A6ACCD;">  -newkey rsa:2048 -nodes -keyout tls.key \\</span></span>\n<span class="line"><span style="color:#A6ACCD;">  -x509 -days 365 -out tls.crt</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>新增 secret：访问 Vault 界面，点击 secrets，点击 enable new engine，选择 KV ，点击 next；填写 path 为 pki ，点击 enable engine；点击 create secret，参见下表填写属性值，点击 save。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>path for this secret</td><td>root</td></tr><tr><td>secret data - key</td><td>tls.crt</td></tr><tr><td>secret data - value</td><td>tls.crt的内容</td></tr><tr><td>secret data - key</td><td>tls.key</td></tr><tr><td>secret data - value</td><td>tls.key的内容</td></tr></tbody></table><ol start="3"><li>新增 policy：访问 Vault 界面，点击 policies，点击 create ACL policy，填写 name 为 pki-root，参见下文代码块填写 policy，点击 create policy。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;pki/data/root&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">  capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><strong>ArgoEvents</strong><br> 在 Vault 中维护 GitHub access token 和 GitHub secret，用于 ArgoEvents 创建 Webhook。</p><ol><li>新增 GitHub access token：访问 GitHub 任意界面，点击右上角的头像，点击 settings &gt; developer settings &gt; personal access token &gt; token(classic)，点击 generate new token(classic) ； 填写 GitHub 账号的密码，点击 confirm；参见下表填写属性值，点击 generator token。请保存好 token，后续将无法再次查看。更多细节参见<a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="noreferrer">官网</a>。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>note</td><td>自定义描述</td></tr><tr><td>expiration</td><td>30days(默认值)</td></tr><tr><td>select scopes(复选框)</td><td>选中范围：<br>admin:repo_hook<br>write:packages（用于 pipeline 向 GitHub package 推送镜像）</td></tr></tbody></table><ol start="2"><li>新增 secret：访问 Vault界面，点击 secrets，点击 enable new engine，选择 KV，点击 next；填写 path 为 git，点击 enable engine；点击 create secret，参见下表填写属性值，点击 save。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>path for this secret</td><td>github/user-project/argoevents/webhook-access</td></tr><tr><td>secret data - key</td><td>token</td></tr><tr><td>secret data - value</td><td>GitHub access token 的内容</td></tr><tr><td>secret data - key</td><td>secret</td></tr><tr><td>secret data - value</td><td>GitHub secret 的内容，可以使用随机字符串（例如 UUID）</td></tr></tbody></table><ol start="3"><li>新增 policy：访问 Vault 界面，点击 policies，点击 create ACL policy，填写 name 为 git-github-user-project-argoevents-webhook-access ，参见下文代码块填写 policy ，点击 create policy。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;git/data/github/user-project/argoevents/webhook-access&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">  capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><strong>pipeline-推送镜像</strong><br> 在 Vault 中维护 GitHub access token，用于 pipeline 向 GitHub package 推送镜像。</p><ol><li><p>配置 GitHub package 的认证账号：重用 ArgoEvents 章节的 GitHub access token ，组成 &lt;GitHub account&gt;:&lt;GitHub access token&gt; 格式的字符，并用 Base64 转码。</p></li><li><p>新增 secret：访问 Vault 界面，点击 secrets ，点击 enable new engine，选择 KV，点击 next；填写 path 为 repo ，点击 enable engine；点击 create secret，参见下表填写属性值，点击 save。</p></li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>path for this secret</td><td>github/container/lanbing/default/readwrite</td></tr><tr><td>secret data - key</td><td>auth</td></tr><tr><td>secret data - value</td><td>&lt;GitHub account&gt;:&lt;GitHub access token&gt; 通过Base64 转码后的内容</td></tr></tbody></table><ol start="3"><li>新增 policy：访问 Vault 界面，点击 policies ，点击 create ACL policy，填写 name 为 repo-github-container-lanbing-default-readwrite ，参见下文代码块填写 policy，点击 create policy。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;repo/data/github/container/lanbing/default/readwrite&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">    capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><strong>pipeline-推送代码</strong><br> 在 Vault 中维护 SSH key ，用于 pipeline 向 GitHub 代码库推送代码。</p><ol><li>新增 SSH key ：更多细节参见<a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent" target="_blank" rel="noreferrer">官网</a>。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 使用Git客户端生成SSH key，邮箱替换为GitHub账号的邮箱 </span></span>\n<span class="line"><span style="color:#A6ACCD;">ssh-keygen -t ed25519 -C </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">your_email@example.com</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>新增 deploy key ： 访问 GitHub 任意界面，点击右上角的头像，点击 your profile；点击 repositories，点击<a href="#%E5%87%86%E5%A4%87">代码库 FD</a> 的名称；进入代码库界面，点击 settings； 在左侧导航栏，点击 deploy keys，然后点击 add deploy key，参考下表填写属性值，点击 add key。更多细节参见<a href="https://docs.github.com/en/developers/overview/managing-deploy-keys#deploy-keys" target="_blank" rel="noreferrer">官网</a>。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>title</td><td>自定义</td></tr><tr><td>key</td><td>SSH公钥内容</td></tr><tr><td>allow write access(复选框)</td><td>选中</td></tr></tbody></table><ol start="3"><li>新增 secret：访问 Vault 界面，点击 secrets ，点击 path 为 git 的 secrets engine ；点击 create secret ，参见下表填写属性值，点击 save 。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>path for this secret</td><td>github/user-deployments/default/readwrite</td></tr><tr><td>secret data - key</td><td>deploykey</td></tr><tr><td>secret data - value</td><td>SSH私钥内容</td></tr></tbody></table><ol start="4"><li>新增 policy：访问 Vault 界面，点击 policies，点击 create ACL policy，填写 name 为 repo-github-container-lanbing-default-readwrite ，参见下文代码块填写 policy ，点击 create policy 。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">path &quot;git/data/github/user-deployments/default/readwrite&quot; {</span></span>\n<span class="line"><span style="color:#A6ACCD;">    capabilities = [&quot;read&quot;]</span></span>\n<span class="line"><span style="color:#A6ACCD;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="安装-argocd" tabindex="-1">安装 ArgoCD <a class="header-anchor" href="#安装-argocd" aria-hidden="true">#</a></h3><p>在 Kubernetes 集群上安装 ArgoCD 。</p><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到Kubernetes集群 </span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#676E95;"># clone目标代码库FC，cd到相对路径cmds，执行安装脚本</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh install-argocd.sh</span></span>\n<span class="line"><span style="color:#676E95;"># 执行补丁脚本 </span></span>\n<span class="line"><span style="color:#A6ACCD;">sh patch-argocd-server.sh</span></span>\n<span class="line"></span></code></pre></div><h3 id="安装-argocd-app" tabindex="-1">安装 ArgoCD app <a class="header-anchor" href="#安装-argocd-app" aria-hidden="true">#</a></h3><p><strong>替换服务地址</strong><br> 替换 ArgoCD app 监听的源代码库地址、目标集群地址，以及变更地址后的关联配置。详情参见<a href="#%E6%9B%BF%E6%8D%A2%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE">替换服务地址配置</a>。</p><ol><li>更新模板参数：根据下文的脚本模板，替换代码库地址、集群地址等，详见代码注释。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 目标代码库FC</span></span>\n<span class="line"><span style="color:#676E95;"># 批量替换ArgoCD监听的代码库地址为目标代码库地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#https://github.com/lanbingcloud/demo-cicd-tekton-argocd.git#https://github.com/zhangsan/demo-cicd-tekton-argocd.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">grep https://github.com/lanbingcloud/demo-cicd-tekton-argocd.git -rl demo-cicd-tekton-argocd</span><span style="color:#89DDFF;">`</span></span>\n<span class="line"><span style="color:#676E95;"># 替换部署运行环境中ArgoCD监听的代码库地址为FD</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#https://github.com/lanbingcloud/demo-user-deployments.git#https://github.com/zhangsan/demo-user-deployments.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-cicd-tekton-argocd/runtimes/deployment1-runtime/production/user-test-app.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 批量替换宿主机IP、Vault服务端IP(这里Vault也安装在同一台宿主机)</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#192.168.0.184#192.168.0.243#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">grep 192.168.0.184 -rl demo-cicd-tekton-argocd</span><span style="color:#89DDFF;">`</span></span>\n<span class="line"><span style="color:#676E95;"># 批量替换ArgoCD、pipeline的Ingress域名</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#119-8-58-20#119-8-99-179#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">grep 119-8-58-20 -rl demo-cicd-tekton-argocd</span><span style="color:#89DDFF;">`</span></span>\n<span class="line"><span style="color:#676E95;"># 替换ArgoEvents中EventSource的repo，包括owner和names</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#lanbingcloud#zhangsan#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-cicd-tekton-argocd/argo-events/overlays/production/eventsource.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#demo-user-project#demo-user-project#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-cicd-tekton-argocd/argo-events/overlays/production/eventsource.yaml</span></span>\n<span class="line"><span style="color:#676E95;">#  替换ArgoEvents中init-pipeline的git-clone代码库地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#https://github.com/lanbingcloud/demo-user-project.git#https://github.com/zhangsan/demo-user-project.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-cicd-tekton-argocd/argo-events/overlays/production/init-pipeline.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 目标代码库FP</span></span>\n<span class="line"><span style="color:#676E95;"># 替换pipeline中拉取代码、推送代码、镜像仓库的地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#https://github.com/lanbingcloud/demo-user-project.git#https://github.com/zhangsan/demo-user-project.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-user-project/pipelines/test-deployment-pipeline.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#git@github.com:lanbingcloud/demo-user-deployments.git#git@github.com:zhangsan/demo-user-deployments.git#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-user-project/pipelines/test-deployment-pipeline.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 替换镜像仓库地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#ghcr.io/lanbingcloud#ghcr.io/zhangsan#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> demo-user-project/pipelines/test-deployment-pipeline.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 目标代码库FD</span></span>\n<span class="line"><span style="color:#676E95;"># 替换image地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#ghcr.io/lanbingcloud#ghcr.io/zhangsan#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-user-deployments/deployments/test/devops-sample.yaml </span></span>\n<span class="line"><span style="color:#676E95;"># 替换应用的Ingress域名</span></span>\n<span class="line"><span style="color:#A6ACCD;">sed -i -e </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s#119-8-58-20#119-8-99-179#g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  demo-user-deployments/deployments/test/devops-sample-svc.yaml </span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>批量替换服务地址：clone（git clone） 目标代码库，执行脚本，批量替换目标代码库的服务地址。push（git push） 替换服务地址后的代码到目标代码库。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">sh sed-demo.sh</span></span>\n<span class="line"></span></code></pre></div><p><strong>安装根 project 和根 app</strong></p><ol><li>安装 app：执行命令，安装根 project 和根 app 。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># cd到目标代码库FC的根目录，安装根project</span></span>\n<span class="line"><span style="color:#A6ACCD;">kubectl -n argocd apply -f project.yaml</span></span>\n<span class="line"><span style="color:#676E95;"># 安装根app</span></span>\n<span class="line"><span style="color:#A6ACCD;">kubectl -n argocd apply -f app.yaml</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>跟踪 app：执行命令，获取 ArgoCD 初始密码、并查看 patch app 和 traefik app 的同步状态，当两个 app 同步完成，可以访问 <a href="#%E5%AE%89%E8%A3%85%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E7%9A%84-argocd-%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80"> ArgoCD 界面</a> ，界面显示 root 和 cert-manager 同步失败。其中，vcluster 集群没有被注册到 ArgoCD ，造成 runtime-argocd-appset 和 runtime-appset 找不到目标集群，root app 同步失败；Kubernetes 集群 和 vcluster 集群的认证没有被同步到 Vault，导致部署在集群中的工具（例如CertManager、ArgoEvents）获取密钥失败。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到Kubernetes集群 </span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#676E95;"># cd到目标代码库FC的相对路径cmds，执行脚本获取ArgoCD初始密码</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-argocd-admin-pwd.sh</span></span>\n<span class="line"><span style="color:#676E95;"># 查看ArgoCD app状态</span></span>\n<span class="line"><span style="color:#A6ACCD;">kubectl get apps -n argocd</span></span>\n<span class="line"></span></code></pre></div><h3 id="注册-vcluster" tabindex="-1">注册 vcluster <a class="header-anchor" href="#注册-vcluster" aria-hidden="true">#</a></h3><p>向 Kubernetes 集群的 ArgoCD 注册 vcluster 集群，包括流水线运行集群和部署运行集群，用于 ArgoCD 在 vcluster 集群中安装相关工具。</p><ol><li>准备：配置 vcluster 集群的 kubeconfig 文件。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到Kubernetes集群，cd到目标代码库FC的相对路径cmds，执行脚本获取vcluster的kubeconfig</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#676E95;"># 获取流水线运行集群的kubeconfig</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-vcluster-kubeconfig.sh vcluster1</span></span>\n<span class="line"><span style="color:#676E95;"># 获取部署运行集群的kubeconfig</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-vcluster-kubeconfig.sh vcluster2</span></span>\n<span class="line"><span style="color:#676E95;"># 分别修改kubeconfig文件，保存到宿主机指定目录</span></span>\n<span class="line"><span style="color:#A6ACCD;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">clusters:</span></span>\n<span class="line"><span style="color:#A6ACCD;">- cluster:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    certificate-authority-data: ...</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># https://&lt;宿主机内网IP&gt;:&lt;集群所在命名空间中svc的nodeport&gt;</span></span>\n<span class="line"><span style="color:#A6ACCD;">    server: https://192.168.0.243:31543    </span></span>\n<span class="line"><span style="color:#A6ACCD;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">contexts:</span></span>\n<span class="line"><span style="color:#A6ACCD;">- context:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    cluster: </span><span style="color:#C792EA;">local</span></span>\n<span class="line"><span style="color:#A6ACCD;">    namespace: default</span></span>\n<span class="line"><span style="color:#A6ACCD;">    user: user</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">#自定义名称</span></span>\n<span class="line"><span style="color:#A6ACCD;">  name: Default31543  </span></span>\n<span class="line"><span style="color:#676E95;">#自定义名称 </span></span>\n<span class="line"><span style="color:#A6ACCD;">current-context: Default31543  </span></span>\n<span class="line"><span style="color:#A6ACCD;">...</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>注册：使用 Argocd 命令注册 vcluster。</li></ol><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;"># 切换到Kubernetes集群，查看svc为argocd-server的ClusterIP</span></span>\n<span class="line"><span style="color:#A6ACCD;">kubectl get svc argocd-server -n argocd</span></span>\n<span class="line"><span style="color:#A6ACCD;"># cd到目标代码库FC的相对路径cmds，执行脚本获取ArgoCD初始密码</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-argocd-admin-pwd.sh</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 执行命令登录Argocd，格式为：argocd login &lt;argocd-server的ClusterIP&gt;</span></span>\n<span class="line"><span style="color:#A6ACCD;">argocd login xxx.xxx.xxx.xxx</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 执行命令注册vcluster，格式为：argocd cluster add &lt;cluster-name&gt; --kubeconfig=&lt;kubeconfig.yaml&gt;</span></span>\n<span class="line"><span style="color:#A6ACCD;">argocd cluster add Default31543 --kubeconfig=/opt/vcluster/kubeconfig-31543.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">argocd cluster add Default31544 --kubeconfig=/opt/vcluster/kubeconfig-31544.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;"># 查询vcluster是否注册成功</span></span>\n<span class="line"><span style="color:#A6ACCD;">argocd cluster list</span></span>\n<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><ol start="3"><li>验证：访问 <a href="#%E5%AE%89%E8%A3%85%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E7%9A%84-argocd-%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">Kubernetes 集群的 ArgoCD 界面</a>，等待 ArgoCD 自动同步，最终 root app 将更新为同步成功。如果想立即验证效果，可以删除 runtime-appset、runtime-argocd-appset ，ArgoCD 将立即生成资源，root app 更新为同步成功。</li></ol><h3 id="同步集群认证" tabindex="-1">同步集群认证 <a class="header-anchor" href="#同步集群认证" aria-hidden="true">#</a></h3><p><strong>同步 Kubernetes 集群认证</strong><br> 向 Vault 同步 Kubernetes 集群认证，用于部署在 Kubernetes 集群中的工具获取 Vault 密钥。</p><ol><li>获取 Kubernetes 集群认证的信息：包括 CA 证书、service account token、host 地址。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到Kubernetes集群，cd到目标代码库FC的相对路径cmds，执行脚本get-cluster-ca.sh获取CA证书</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=</span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-cluster-ca.sh </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">KUBECONFIG</span></span>\n<span class="line"><span style="color:#676E95;"># 执行get-vault-auth-token.sh获取token</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-vault-auth-token.sh</span></span>\n<span class="line"><span style="color:#676E95;"># 查看kubeconfig文件获取host地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">cat </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/.kube/config</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>启用 Kubernetes 认证方法：访问 Vault界面，点击 access ，点击 enable new method，选择 Kubernetes ，点击 next ; 填写 path 为 host-cluster ，点击 enable method ；参见下表填写属性值，点击 save。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Kubernetes host</td><td>host 地址</td></tr><tr><td>Kubernetes CA Certificate</td><td>CA 证书</td></tr><tr><td>token reviewer JWT</td><td>service account token</td></tr></tbody></table><ol start="3"><li>新增 role ：访问 Vault 界面，点击 access ，点击 path 为 host-cluster 的认证方法链接；点击 create role ，参见下表填写属性值，点击 save。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>name</td><td>cert-manager</td></tr><tr><td>bound service account names</td><td>default</td></tr><tr><td>bound service account namespaces</td><td>cert-manager</td></tr><tr><td>generated token&#39;s policies</td><td>pki-root</td></tr></tbody></table><ol start="4"><li>验证：访问 <a href="#%E5%AE%89%E8%A3%85%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E7%9A%84-argocd-%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">Kubernetes 集群的 ArgoCD 界面</a>，等待 ArgoCD 自动同步，最终 cert-manager app 将更新为同步成功。如果想立即验证效果，可以删除资源：类型为 SecretStore 的 cert-manager-secretstore、类型为 ExternalSecret 的 root-issuer 、类型为 ClusterIssuer 的 org-issuer ， ArgoCD 将立即生成资源，cert-manager app 更新为同步成功。</li></ol><p><strong>同步 vcluster 集群认证</strong><br> 向 Vault 同步 vcluster 集群认证，这里指的是流水线运行集群，用于部署在 vcluster 集群中的工具获取 Vault 密钥。</p><ol><li>获取 vcluster 集群认证的信息：包括 CA 证书、service account token、host地址。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到vcluster集群，cd到目标代码库FC的相对路径cmds，执行脚本get-cluster-ca.sh获取CA证书</span></span>\n<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG=/opt/vcluster/kubeconfig-31543.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-cluster-ca.sh </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">KUBECONFIG</span></span>\n<span class="line"><span style="color:#676E95;"># 执行get-vault-auth-token.sh获取token</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-vault-auth-token.sh</span></span>\n<span class="line"><span style="color:#676E95;"># 查看kubeconfig文件获取host地址</span></span>\n<span class="line"><span style="color:#A6ACCD;">cat /opt/vcluster/kubeconfig-31543.yaml</span></span>\n<span class="line"></span></code></pre></div><ol start="2"><li>启用 Kubernetes 认证方法：访问 Vault界面，点击 access ，点击 enable new method，选择 Kubernetes ，点击 next ; 填写 path 为 pipeline1-cluster ，点击 enable method ；参见下表填写属性值，点击 save。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>Kubernetes host</td><td>host 地址</td></tr><tr><td>Kubernetes CA Certificate</td><td>CA 证书</td></tr><tr><td>token reviewer JWT</td><td>service account token</td></tr></tbody></table><ol start="3"><li>新增 role：访问 Vault 界面，点击 access ，点击 path 为 pipeline1-cluster 的认证方法链接；点击 create role ，参见下表填写属性值，点击 save。</li></ol><table><thead><tr><th>属性</th><th>取值</th></tr></thead><tbody><tr><td>name</td><td>argo-events-sa</td></tr><tr><td>bound service account names</td><td>argo-events-sa</td></tr><tr><td>bound service account namespaces</td><td>argo-events</td></tr><tr><td>generated token&#39;s policies</td><td>git-github-user-project-argoevents-webhook-access</td></tr><tr><td>name</td><td>user-pipelines</td></tr><tr><td>bound service account names</td><td>default</td></tr><tr><td>bound service account namespaces</td><td>user-pipelines</td></tr><tr><td>generated token&#39;s policies</td><td>git-github-user-deployments-default-readwrite<br>repo-github-container-lanbing-default-readwrite</td></tr></tbody></table><ol start="4"><li>验证：访问 <a href="#%E5%AE%89%E8%A3%85%E5%9C%A8-vcluster-%E9%9B%86%E7%BE%A4%E7%9A%84-argocd-%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">vcluster 集群的 ArgoCD 界面</a>，等待 ArgoCD 自动同步，最终 argo-events app 将更新为同步成功。如果想立即验证效果，可以删除资源：类型为 SecretStore 的 webhook-secretstore 、类型为 ExternalSecret 的 github-access 、类型为 EventSource 的 webhook ，ArgoCD 将立即生成资源，argo-events app 更新为同步成功。</li></ol><div class="language-Shell"><button class="copy"></button><span class="lang">Shell</span><pre><code><span class="line"><span style="color:#676E95;"># 切换到vcluster集群，cd到目标代码库FC的相对路径cmds，执行脚本获取ArgoCD初始密码</span></span>\n<span class="line"><span style="color:#A6ACCD;">sh get-argocd-admin-pwd.sh</span></span>\n<span class="line"></span></code></pre></div><h3 id="执行流水线" tabindex="-1">执行流水线 <a class="header-anchor" href="#执行流水线" aria-hidden="true">#</a></h3><p>向<a href="#%E5%87%86%E5%A4%87">目标代码库 FP</a> 提交代码（例如修改pom文件的项目版本），<a href="#tekton-dashboard-%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80">访问 Tekton dashboard</a> 跟踪流水线已经自动执行。 <img src="'+n+'" alt="directive syntax graph"></p><p>查看流水线的执行详情，可以查看部署成功后的返回消息。 <img src="/docs/assets/CI-11.b6674e41.jpg" alt="directive syntax graph"></p><h2 id="附件" tabindex="-1">附件 <a class="header-anchor" href="#附件" aria-hidden="true">#</a></h2><h3 id="参考链接" tabindex="-1">参考链接 <a class="header-anchor" href="#参考链接" aria-hidden="true">#</a></h3><p><strong>GitHub demo 示例</strong><br><a href="https://github.com/lanbingcloud/demo-vcluster-tekton-argoevents-vaultagent-externalsecrets" target="_blank" rel="noreferrer">https://github.com/lanbingcloud/demo-vcluster-tekton-argoevents-vaultagent-externalsecrets</a><br><a href="https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton" target="_blank" rel="noreferrer">https://github.com/lanbingcloud/demo-pipeline-argoevents-tekton</a><br><a href="https://github.com/lanbingcloud/demo-cicd-tekton-argocd" target="_blank" rel="noreferrer">https://github.com/lanbingcloud/demo-cicd-tekton-argocd</a></p><p><strong>B站讲解视频</strong><br><a href="https://www.bilibili.com/video/BV1yP4y1U7mS/" target="_blank" rel="noreferrer">部署基础环境</a><br><a href="https://www.bilibili.com/video/BV1Fm4y1A7qL/" target="_blank" rel="noreferrer">构建CI流水线</a><br><a href="https://www.bilibili.com/video/BV1Be411G7H6/" target="_blank" rel="noreferrer">集成CD环境</a></p><h3 id="安装在-kubernetes-集群的-argocd-访问地址" tabindex="-1">安装在 Kubernetes 集群的 ArgoCD 访问地址 <a class="header-anchor" href="#安装在-kubernetes-集群的-argocd-访问地址" aria-hidden="true">#</a></h3><p>协议：HTTPS<br> 地址：来自production/patch/ingress-argocd.yaml的hosts<br> 端口：来自production/traefik-app.yaml的websecure.nodePort<br> 示例：<a href="https://argocd.119-8-99-179.nip.io:30443" target="_blank" rel="noreferrer">https://argocd.119-8-99-179.nip.io:30443</a></p><h3 id="安装在-vcluster-集群的-argocd-访问地址" tabindex="-1">安装在 vcluster 集群的 ArgoCD 访问地址 <a class="header-anchor" href="#安装在-vcluster-集群的-argocd-访问地址" aria-hidden="true">#</a></h3><p>协议：HTTPS<br> 地址：来自runtimes/pipeline1-runtime/production/patch/ingress-argocd.yaml的hosts<br> 端口：来自production/traefik-app.yaml的websecure.nodePort<br> 示例：<a href="https://argocd.pipeline1.119-8-99-179.nip.io:30443" target="_blank" rel="noreferrer">https://argocd.pipeline1.119-8-99-179.nip.io:30443</a></p><h3 id="tekton-dashboard-访问地址" tabindex="-1">Tekton dashboard 访问地址 <a class="header-anchor" href="#tekton-dashboard-访问地址" aria-hidden="true">#</a></h3><p>协议：HTTP<br> 地址：来自tekton/overlays/production/dashboard-ingress.yaml的host<br> 端口：来自production/traefik-app.yaml的web.nodePort<br> 示例：<a href="http://tekton.pipeline1.119-8-99-179.nip.io:30080" target="_blank" rel="noreferrer">http://tekton.pipeline1.119-8-99-179.nip.io:30080</a></p><h3 id="替换服务地址配置" tabindex="-1"><strong>替换服务地址配置</strong> <a class="header-anchor" href="#替换服务地址配置" aria-hidden="true">#</a></h3><h4 id="代码库：demo-cicd-tekton-argocd" tabindex="-1">代码库：demo-cicd-tekton-argocd <a class="header-anchor" href="#代码库：demo-cicd-tekton-argocd" aria-hidden="true">#</a></h4><p>clone <a href="#%E5%87%86%E5%A4%87">目标代码库 FC</a>，修改服务配置。包括监听的代码库地址、宿主机 IP 、Ingress 域名、监听的repo等。</p><h5 id="替换监听的代码库地址" tabindex="-1">替换监听的代码库地址 <a class="header-anchor" href="#替换监听的代码库地址" aria-hidden="true">#</a></h5><p>相对路径：app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/{{runtime}}</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/cert-manager-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cert-manager/overlays/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-argocd-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd/overlays/production</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/vcluster-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vclusters/{{cluster}}</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">production/patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：vclusters/vcluster1/vcluster1-patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vclusters/vcluster1/vcluster1-patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/pipeline1-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/pipeline1-runtime/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/argo-events-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argo-events/overlays/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/user-namespaces-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user-namespaces</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/tekton-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tekton/overlays/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/pipeline1-runtime/production/patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/deployment1-runtime/deployment1-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-deployment</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/deployment1-runtime/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/deployment1-runtime/production/patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-deployment</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/deployment1-runtime/production/patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/deployment1-runtime/production/user-test-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-deployment</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deployments/test</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-user-deployments.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/argo-events-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argo-events/overlays/production</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：vclusters/vcluster2/vcluster2-patch-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vclusters/vcluster2/vcluster2-patch</span></span>\n<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># 替换为目标代码库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换宿主机-ip-、vault-服务端-ip" tabindex="-1">替换宿主机 IP 、Vault 服务端 IP <a class="header-anchor" href="#替换宿主机-ip-、vault-服务端-ip" aria-hidden="true">#</a></h5><p>相对路径：vclusters/vcluster1/vcluster1-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        vcluster:</span></span>\n<span class="line"><span style="color:#C3E88D;">          image: rancher/k3s:v1.21.13-k3s1</span></span>\n<span class="line"><span style="color:#C3E88D;">        syncer:</span></span>\n<span class="line"><span style="color:#C3E88D;">          extraArgs:</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">          - --tls-san=192.168.0.243   # 替换为宿主机的内网IP</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：vclusters/vcluster2/vcluster2-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        vcluster:</span></span>\n<span class="line"><span style="color:#C3E88D;">          image: rancher/k3s:v1.21.13-k3s1</span></span>\n<span class="line"><span style="color:#C3E88D;">        syncer:</span></span>\n<span class="line"><span style="color:#C3E88D;">          extraArgs:</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">          - --tls-san=192.168.0.243   # 替换为宿主机的内网IP</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：argo-events/overlays/production/secretstore.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">provider</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">vault</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;"># 替换为Vault服务端的IP和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://192.168.0.243:31820</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">git</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">v2</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：cert-manager/overlays/production/secretstore.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">provider</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">vault</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;"># 替换为Vault服务端的IP和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://192.168.0.243:31820</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pki</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">v2</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/metallb-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        configInline:</span></span>\n<span class="line"><span style="color:#C3E88D;">          address-pools:</span></span>\n<span class="line"><span style="color:#C3E88D;">          - name: default</span></span>\n<span class="line"><span style="color:#C3E88D;">            protocol: layer2</span></span>\n<span class="line"><span style="color:#C3E88D;">            addresses:</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">            - 192.168.0.243-192.168.0.243    # 替换为宿主机的内网IP</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">generators</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">list</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">elements</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">runtime</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pipeline1-runtime</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标集群的IP地址和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">clusterURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://192.168.0.243:31543</span><span style="color:#A6ACCD;">    </span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runtimes/{{runtime}}</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">destination</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{{clusterURL}}</span><span style="color:#89DDFF;">&#39;</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/vault-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        global:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: false</span></span>\n<span class="line"><span style="color:#C3E88D;">        injector:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: true</span></span>\n<span class="line"><span style="color:#C3E88D;">          authPath: auth/host-cluster</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">          externalVaultAddr: http://192.168.0.243:31820  #替换为Vault服务端的IP和端口</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/runtime-argocd-appset.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">generators</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">list</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">elements</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">runtime</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pipeline1-runtime-argocd</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标集群的IP地址和端口</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">clusterURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://192.168.0.243:31543</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-vcluster</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">repoURL</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-cicd-tekton-argocd.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">targetRevision</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HEAD</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd/overlays/production</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">destination</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{{clusterURL}}</span><span style="color:#89DDFF;">&#39;</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/vault-app.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">project</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-pipeline</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">helm</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C792EA;">-</span></span>\n<span class="line"><span style="color:#C3E88D;">        global:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: false</span></span>\n<span class="line"><span style="color:#C3E88D;">        injector:</span></span>\n<span class="line"><span style="color:#C3E88D;">          enabled: true</span></span>\n<span class="line"><span style="color:#C3E88D;">          authPath: auth/pipeline1-cluster</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">          externalVaultAddr: http://192.168.0.243:31820  #替换为Vault服务端的IP和端口</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换-ingress-域名" tabindex="-1">替换 Ingress 域名 <a class="header-anchor" href="#替换-ingress-域名" aria-hidden="true">#</a></h5><p>相对路径：argo-events/overlays/production/eventsource.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">github</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">user-project</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">webhook</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">endpoint</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/user-project</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">12000</span><span style="color:#89DDFF;">&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">method</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">POST</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">http://webhook.pipeline1.119-8-99-179.nip.io:30080</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：argo-events/overlays/production/ingress-webhook-eventsource.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">networking.k8s.io/v1</span></span>\n<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Ingress</span></span>\n<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">webhook-eventsource</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argo-events</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">webhook.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：production/patch/ingress-argocd.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/production/patch/ingress-argocd.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：tekton/overlays/production/dashboard-ingress.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tekton.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：argocd/overlays/production/argocd-notifications-cm-patch.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">data</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换宿主机IP</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">service.webhook.deployments-status</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span></span>\n<span class="line highlighted"><span style="color:#C3E88D;">    url: http://user-webhook.pipeline1.119-8-99-179.nip.io:30080/deployments-status</span></span>\n<span class="line"><span style="color:#C3E88D;">    headers:</span></span>\n<span class="line"><span style="color:#C3E88D;">    - name: Content-Type</span></span>\n<span class="line"><span style="color:#C3E88D;">      value: application/json</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/deployment1-runtime/production/patch/ingress-argocd.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：runtimes/pipeline1-runtime/user-namespaces/ingress-webhook-eventsource.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">argocd.pipeline1.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换-argoevents-eventsource-的-repo" tabindex="-1">替换 ArgoEvents EventSource 的 repo <a class="header-anchor" href="#替换-argoevents-eventsource-的-repo" aria-hidden="true">#</a></h5><p>相对路径：argo-events/overlays/production/eventsource.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">github</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">user-project</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">repositories</span><span style="color:#89DDFF;">:</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">owner</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">zhangsan</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;"># 替换为EventSource监听代码库的owner</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">names</span><span style="color:#89DDFF;">:</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">demo-user-project</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;"># 替换为EventSource监听代码库的name</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><h5 id="替换-init-pipeline-中-git-clone-的代码库地址" tabindex="-1">替换 init-pipeline 中 git clone 的代码库地址 <a class="header-anchor" href="#替换-init-pipeline-中-git-clone-的代码库地址" aria-hidden="true">#</a></h5><p>相对路径：argo-events/overlays/production/init-pipeline.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#C3E88D;">spec</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">triggers</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init-pipeine</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">k8s</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">operation</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">create</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">source</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">resource</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#F07178;">pipelineSpec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F07178;">taskRef</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ClusterTask</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F07178;">workspaces</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">output</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">workspace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source-volume</span></span>\n<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">subPath</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">$(params.REVISION)</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">url</span></span>\n<span class="line"><span style="color:#89DDFF;">                      </span><span style="color:#676E95;"># 替换为目标代码库FP的地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">                      </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-user-project.git</span></span>\n<span class="line"></span></code></pre></div><h4 id="代码库：demo-user-project" tabindex="-1">代码库：demo-user-project <a class="header-anchor" href="#代码库：demo-user-project" aria-hidden="true">#</a></h4><p>clone <a href="#%E5%87%86%E5%A4%87">目标代码库 FP</a>，修改服务配置。替换 pipeline 拉取代码、推送代码、镜像仓库的地址。</p><p>相对路径：pipelines/test-deployment-pipeline.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">pipelineSpec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone-sourcecode</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">url</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库FP的地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/zhangsan/demo-user-project.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-clone-deployment</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">url</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为目标代码库FD的地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git@github.com:zhangsan/demo-user-deployments.git</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">image-build</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">runAfter</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mvn-build</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">taskRef</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kaniko</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ClusterTask</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">workspaces</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">workspace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source-volume</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">IMAGE</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换为镜像仓库地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ghcr.io/zhangsan/devops-sample:0.0.1-$(tasks.git-clone-sourcecode.results.commit)</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">DOCKERFILE</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./sourcecode/Dockerfile</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">CONTEXT</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./sourcecode</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">manifest-update</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">runAfter</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">image-build</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">taskRef</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-cli</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ClusterTask</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">workspaces</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">workspace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">source-volume</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">params</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">GIT_SCRIPT</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span></span>\n<span class="line"><span style="color:#C3E88D;">          cd deployment</span></span>\n<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;"># 替换应用部署的镜像地址 </span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">sed -i -e &quot;s#ghcr.io/zhangsan/devops-sample.*#$(tasks.image-build.results.IMAGE_URL)#g&quot; deployments/test/devops-sample.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">git add deployments/test/devops-sample.yaml</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">git commit -a -m &quot;automatic update by pipeline bot</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">$(tasks.image-build.results.IMAGE_URL)&quot;</span></span>\n<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#C3E88D;">git push origin HEAD:$(params.REVISION) --force</span></span>\n<span class="line"></span></code></pre></div><h4 id="代码库：demo-user-deployments" tabindex="-1">代码库：demo-user-deployments <a class="header-anchor" href="#代码库：demo-user-deployments" aria-hidden="true">#</a></h4><p>clone <a href="#%E5%87%86%E5%A4%87">目标代码库 FD</a>，修改服务配置。替换镜像地址、应用的 Ingress 域名。</p><p>相对路径：deployments/test/devops-sample.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">...</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">env</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">CACHE_IGNORE</span></span>\n<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">js|html</span></span>\n<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">CACHE_PUBLIC_EXPIRATION</span></span>\n<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">3d</span></span>\n<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;"># 更新镜像地址</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ghcr.io/zhangsan/devops-sample:0.0.1-bac6ef734161de568fcc9b9d2b598b6b33874227</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div><p>相对路径：deployments/test/devops-sample-svc.yaml</p><div class="language-yaml"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">networking.k8s.io/v1</span></span>\n<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Ingress</span></span>\n<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ks-sample-dev</span></span>\n<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rules</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;"># 替换为宿主机外网IP</span></span>\n<span class="line highlighted"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">devops-sample.119-8-99-179.nip.io</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">http</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">:</span></span>\n<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>\n<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">pathType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ImplementationSpecific</span></span>\n<span class="line"><span style="color:#FFCB6B;">...</span></span>\n<span class="line"></span></code></pre></div>',193)];const r=a(t,[["render",function(s,n,a,o,e,t){return l(),p("div",null,c)}]]);export{e as __pageData,r as default};
